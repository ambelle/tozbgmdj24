<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<title>Thocky's and Gillian's BGM Quiz</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0" />

<style>
  body{
    font-family: Arial, sans-serif;
    background:#101018;
    color:#f5f5f5;
    text-align:center;
    margin:0;
  }

  /* HEADER */
  .hero{
    padding: 26px 14px 6px;
    max-width: 920px;
    margin: 0 auto;
  }
  .heroCard{
    background: #141420;
    border: 1px solid rgba(255,255,255,0.06);
    box-shadow: 0 0 18px rgba(0,0,0,0.45);
    border-radius: 14px;
    padding: 18px 18px 14px;
  }
  .title{
    margin: 2px 0 6px;
    font-size: 2.05rem;
    font-weight: 900;
    letter-spacing: 0.2px;
    line-height: 1.15;
  }
  .subtitle{
    margin-top: 2px;
    font-weight:800;
    font-size:1rem;
    opacity:0.95;
  }
  .badgeRow{
    display:flex;
    justify-content:center;
    gap:10px;
    flex-wrap:wrap;
    margin-top: 10px;
  }
  .badge{
    display:inline-block;
    padding: 6px 12px;
    border-radius: 999px;
    font-size: 0.85rem;
    font-weight: 800;
    background: rgba(63,140,255,0.14);
    border: 1px solid rgba(63,140,255,0.28);
    color: #cfe2ff;
  }
  .desc{
    margin: 12px auto 0;
    max-width: 780px;
    line-height: 1.55;
    color: #d8d8e6;
    font-size: 0.92rem; /* 1 size smaller */
  }

  #controls, #answers, #excludeBox{
    background:#181824;
    margin:18px auto;
    padding:16px;
    max-width:560px;
    border-radius:10px;
    box-shadow:0 0 12px rgba(0,0,0,0.45);
  }

  button{
    background:#3f8cff;
    color:white;
    border:none;
    padding:7px 12px;
    border-radius:6px;
    cursor:pointer;
    font-weight:700;
    margin: 4px 6px;
  }

  button.secondary{
    background:#444b5f;
  }

  input[type="text"]{
    width:240px;
    padding:7px 10px;
    background:#101018;
    border:1px solid #444;
    color:white;
    border-radius:6px;
  }

  .row{
    display:flex;
    justify-content:center;
    align-items:center;
    gap:10px;
    flex-wrap:wrap;
  }

  .microHint{
    margin-top: 10px;
    font-size: 0.88rem;
    color: #cfcfe6;
    opacity: 0.95;
    display:flex;
    align-items:center;
    justify-content:center;
    gap:10px;
    flex-wrap:wrap;
  }
  .microHint b{ color:#ffffff; }

  .correct{ color:#5bd75b; }
  .wrong{ color:#ff6b6b; }

  #player{ position:absolute; left:-9999px; top:-9999px; }

  #scoreLine{
    margin-top: 10px;
    display:flex;
    justify-content:center;
    gap:14px;
    font-size:1.05rem;
  }

  #resultBox{
    margin-top:12px;
    padding:10px;
    border-radius:8px;
    background:#111120;
    min-height:66px;
  }

  #resultStatus{
    font-weight:900;
    font-size:1.15rem;
  }

  #resultTyped,
  #resultCorrect{
    font-size:0.95rem;
    margin-top:4px;
    color:#cfcfe6;
  }

  #excludeList, #answerList{
    columns:2;
    text-align:left;
    font-size:0.95rem;
    padding-left:18px;
  }

  @media (max-width:600px){
    #excludeList, #answerList{ columns:1; }
    input[type="text"]{ width: 90%; max-width: 280px; }
  }

  .hintBox{
    margin-top: 10px;
    padding: 10px;
    background: rgba(63,140,255,0.08);
    border: 1px solid rgba(63,140,255,0.18);
    border-radius: 10px;
    font-size: 0.9rem;
    color:#d8d8e6;
  }

  /* Volume UI */
  .volWrap{
    display:flex;
    align-items:center;
    gap:10px;
    flex-wrap:wrap;
    justify-content:center;
  }
  input[type="range"]{
    width: 200px;
    accent-color: #3f8cff;
  }
  .smallNote{
    font-size:0.85rem;
    opacity:0.85;
  }

  /* Player status */
  #ytStatus{
    font-size: 0.85rem;
    opacity: 0.85;
    min-height: 1.2em;
    margin-bottom: 8px; /* now sits above Play button */
  }
</style>
</head>

<body>

<!-- HEADER -->
<div class="hero">
  <div class="heroCard">
    <div class="title">
      Thocky's and Gillian's
      <div class="subtitle">TOZ 24F BGM Quiz / Practice</div>
    </div>

    <div class="badgeRow">
      <span class="badge">DreamMS Version</span>
      <span class="badge">Practice Tool</span>
      <span class="badge">TOZ 24F</span>
    </div>

    <p class="desc">
      This tool is to help you practice so you're not a noob and can help the leader for BGM stage.
    </p>
  </div>
</div>

<!-- Hidden YouTube player -->
<div id="player"></div>

<div id="controls">
  <!-- moved status ABOVE play button -->
  <div id="ytStatus"></div>

  <div class="row">
    <button id="playBtn">Play!</button>
    <button id="stopBtn" class="secondary">Stop</button>
  </div>

  <div style="height:10px"></div>

  <div class="row">
    <b>BGM:</b>
    <input type="text" id="guessInput" placeholder="Type map name here" autocomplete="off" />
    <button id="submitBtn">Submit</button>
  </div>

  <div class="microHint">
    <span>Answers are <b>not case-sensitive</b>.</span>
    <span class="smallNote" id="iosNote" style="display:none;">(iPhone Safari: use your phone volume buttons)</span>
  </div>

  <!-- Volume -->
  <div class="volWrap" style="margin-top:10px;">
    <button id="muteBtn" class="secondary">Mute</button>
    <label style="display:flex; align-items:center; gap:8px;">
      <span style="font-weight:800;">Volume</span>
      <input id="volumeSlider" type="range" min="0" max="100" value="70" />
      <span id="volLabel" style="min-width:34px; text-align:left;">70%</span>
    </label>
  </div>

  <div id="resultBox">
    <div id="resultStatus"></div>
    <div id="resultTyped"></div>
    <div id="resultCorrect"></div>
  </div>

  <div id="scoreLine">
    <div>Correct: <span id="correctCount" class="correct">0</span></div>
    <div>Wrong: <span id="wrongCount" class="wrong">0</span></div>
  </div>

  <button id="resetBtn" class="secondary">Reset</button>
</div>

<div id="excludeBox">
  <h3>Exclude BGMs from Practice</h3>
  <p style="margin-top:6px; color:#d8d8e6;">
    Select BGMs you already mastered.<br>
    <b>Any checked BGM will be excluded</b> and will not appear in the quiz.
  </p>

  <div class="row" style="margin-top:8px;">
    <button id="excludeAllBtn">Exclude All</button>
    <button id="includeAllBtn" class="secondary">Include All</button>
  </div>

  <div class="hintBox">
    Tip: Exclude everything first, then untick only the BGMs you want to focus on.
  </div>

  <ul id="excludeList"></ul>
</div>

<div id="answers">
  <h3>Available BGMs</h3>
  <ul id="answerList"></ul>
</div>

<script>
/* =========================
   32 BGM playlist
   ========================= */
const playlist = [
  { name: "Amoria", id: "hCdooZxzISo" },
  { name: "Aquarium", id: "qtw0sIBLjrw" },
  { name: "Ariant", id: "w1RgDSoOajw" },
  { name: "Boat Quay Town", id: "GSDD0c_7FV0" },
  { name: "CBD", id: "czDfxrSGea4" },
  { name: "El Nath", id: "X6X7U5V9Obk" },
  { name: "Ellin Forest", id: "8FShyABhIAs" },
  { name: "Ellinia", id: "gfgBDs8z6WE" },
  { name: "Ereve", id: "3r9s43TG9yA" },
  { name: "Florina Beach", id: "9VqPnUL9Qvs" },
  { name: "Golden Temple", id: "Y_cihkgxF9A" },
  { name: "Henesys", id: "s2_MAplvHeQ" },
  { name: "Herb Town", id: "59oze7IkQ10" },
  { name: "Kampung Village", id: "aJNseQp1Tb4" },
  { name: "Kerning City", id: "uv8QObpL2EY" },
  { name: "Korean Folk Town", id: "KK_IjvtszTA" },
  { name: "Leafre", id: "theIdIhZzVE" },
  { name: "Lith Harbor", id: "F6LIFBVhObQ" },
  { name: "Ludibrium", id: "49AZqVhXVeU" },
  { name: "Magatia", id: "5FDFLwPw0bU" },
  { name: "Mu Lung", id: "2VMCpGe9MGc" },
  { name: "Mushroom Shrine", id: "SdcsTuVLJk0" },
  { name: "Nautilus", id: "iZaVKkfuD6s" },
  { name: "New Leaf City", id: "EXv5madDarI" },
  { name: "Omega Sector", id: "LxQt8EVhBOs" },
  { name: "Orbis", id: "DThWMbPZXy8" },
  { name: "Perion", id: "9lwOsX763N0" },
  { name: "Rien", id: "YDfIfL_Fxec" },
  { name: "Shanghai", id: "uZ3egkrlMZY" },
  { name: "Showa Town", id: "58QPkwCSd4Y" },
  { name: "Sleepywood", id: "tWCWIhA3XQw" },
  { name: "Temple of Time", id: "6uCaEDM-Kf8" }
];

/* Sort A-Z for lists (does NOT affect play randomness) */
const playlistSorted = [...playlist].sort((a,b) => a.name.localeCompare(b.name));

/* =========================
   State
   ========================= */
let excluded = JSON.parse(localStorage.getItem("excludedBGMs") || "[]");
let currentIndex = null;

let player = null;
let playerReady = false;

/* No-repeat window */
const NO_REPEAT_WINDOW = 8;
let recentIndices = [];

/* DOM helper */
const $ = (id) => document.getElementById(id);

function isIOSSafari(){
  const ua = navigator.userAgent;
  const isIOS = /iPad|iPhone|iPod/.test(ua);
  const isSafari = isIOS && /Safari/.test(ua) && !/CriOS|FxiOS|EdgiOS/.test(ua);
  return isSafari;
}

function setYTStatus(msg){
  const el = $("ytStatus");
  if (el) el.textContent = msg;
}

/* =========================
   Robust YouTube API loader
   ========================= */
function loadYouTubeAPI(){
  if (window.YT && window.YT.Player){
    setYTStatus("YouTube API ready. Initializing player...");
    initPlayer();
    return;
  }

  window.onYouTubeIframeAPIReady = function(){
    setYTStatus("YouTube API loaded. Initializing player...");
    initPlayer();
  };

  if (!document.getElementById("yt-iframe-api")){
    setYTStatus("Loading YouTube player...");
    const tag = document.createElement("script");
    tag.id = "yt-iframe-api";
    tag.src = "https://www.youtube.com/iframe_api";
    tag.onerror = () => setYTStatus("Failed to load YouTube API (blocked by content filter?)");
    document.head.appendChild(tag);
  }
}

function initPlayer(){
  if (player) return;

  try{
    player = new YT.Player("player", {
      height: "180",
      width: "320",
      videoId: playlist[0].id,
      playerVars: { playsinline: 1 },
      events: {
        onReady: (event) => {
          playerReady = true;
          setYTStatus("Player ready âœ…");
          const iframe = event.target.getIframe();
          if (iframe) iframe.setAttribute("allow", "autoplay; encrypted-media");
          applyVolumeFromUI();
        },
        onError: (e) => {
          playerReady = false;
          setYTStatus("YouTube error: " + e.data + " (video blocked/unavailable?)");
        }
      }
    });
  } catch(err){
    playerReady = false;
    setYTStatus("Player init error. Refresh and try again.");
  }
}

/* =========================
   Pool / Random selection
   ========================= */
function getPoolIndices(){
  const pool = [];
  for (let i = 0; i < playlist.length; i++){
    if (!excluded.includes(playlist[i].name)) pool.push(i);
  }
  return pool;
}

function getNextIndex(){
  const pool = getPoolIndices();
  if (!pool.length) return null;

  const available = pool.filter(i => !recentIndices.includes(i));
  const pickFrom = available.length ? available : pool;

  const idx = pickFrom[Math.floor(Math.random() * pickFrom.length)];
  recentIndices.push(idx);
  if (recentIndices.length > NO_REPEAT_WINDOW) recentIndices.shift();
  return idx;
}

function playRandom(){
  if (!playerReady || !player){
    alert("Player is still loading, try again in a moment.");
    return;
  }

  const idx = getNextIndex();
  if (idx === null) return alert("All BGMs excluded!");

  currentIndex = idx;
  player.loadVideoById(playlist[idx].id);
  player.playVideo();
}

/* stop */
function stop(){
  if (player && player.stopVideo) player.stopVideo();
  currentIndex = null;
}

/* =========================
   Answer rules (aliases)
   ========================= */
function normalizeAnswer(s){
  return (s || "")
    .trim()
    .toLowerCase()
    .replace(/\s+/g, " ");
}

function isCorrectAnswer(guessRaw, correctName){
  const guess = normalizeAnswer(guessRaw);
  const correct = normalizeAnswer(correctName);

  if (guess === correct) return true;

  // Special: Mushroom Shrine accepts "Zipangu"
  if (correct === "mushroom shrine"){
    if (guess === "zipangu") return true;
  }

  return false;
}

/* =========================
   Answer submit
   ========================= */
function submitAnswer(){
  if (currentIndex === null) return alert("Press Play first!");

  const input = $("guessInput");
  const guessRaw = input.value.trim();
  if (!guessRaw) return alert("Please type your answer.");

  const correctName = playlist[currentIndex].name;

  $("resultTyped").textContent = "You submitted: " + guessRaw;
  $("resultCorrect").textContent = "Correct answer: " + correctName;

  if (isCorrectAnswer(guessRaw, correctName)){
    $("resultStatus").textContent = "Correct";
    $("resultStatus").className = "correct";
    $("correctCount").textContent = Number($("correctCount").textContent) + 1;
  } else {
    $("resultStatus").textContent = "Wrong";
    $("resultStatus").className = "wrong";
    $("wrongCount").textContent = Number($("wrongCount").textContent) + 1;
  }

  input.value = "";
  input.focus();
  playRandom();
}

/* =========================
   Volume control
   ========================= */
function applyVolumeFromUI(){
  if (!playerReady || !player || !player.setVolume) return;

  const v = Number($("volumeSlider").value);
  $("volLabel").textContent = v + "%";
  try { player.setVolume(v); } catch(e) {}
}

function toggleMute(){
  if (!playerReady || !player) return;

  if (player.isMuted && player.isMuted()){
    player.unMute();
    $("muteBtn").textContent = "Mute";
  } else {
    player.mute();
    $("muteBtn").textContent = "Unmute";
  }
}

/* =========================
   Build lists (A-Z)
   ========================= */
function buildLists(){
  const answerList = $("answerList");
  const excludeList = $("excludeList");
  answerList.innerHTML = "";
  excludeList.innerHTML = "";

  playlistSorted.forEach((p) => {
    // Available list
    const li = document.createElement("li");
    li.textContent = p.name;
    answerList.appendChild(li);

    // Exclude list
    const ex = document.createElement("li");
    ex.innerHTML = `<label>
      <input type="checkbox" ${excluded.includes(p.name) ? "checked" : ""}>
      ${p.name}
    </label>`;

    ex.querySelector("input").addEventListener("change", (e) => {
      if (e.target.checked){
        if (!excluded.includes(p.name)) excluded.push(p.name);
      } else {
        excluded = excluded.filter(x => x !== p.name);
      }
      localStorage.setItem("excludedBGMs", JSON.stringify(excluded));
    });

    excludeList.appendChild(ex);
  });
}

/* =========================
   Init
   ========================= */
window.addEventListener("DOMContentLoaded", () => {
  if (isIOSSafari()){
    $("iosNote").style.display = "inline";
  }

  buildLists();

  $("playBtn").onclick = playRandom;
  $("stopBtn").onclick = stop;
  $("submitBtn").onclick = submitAnswer;

  $("guessInput").addEventListener("keydown", (e) => {
    if (e.key === "Enter"){
      e.preventDefault();
      submitAnswer();
    }
  });

  $("resetBtn").onclick = () => {
    $("correctCount").textContent = "0";
    $("wrongCount").textContent = "0";
    $("resultStatus").textContent = "";
    $("resultStatus").className = "";
    $("resultTyped").textContent = "";
    $("resultCorrect").textContent = "";
    recentIndices = [];
    currentIndex = null;
  };

  $("excludeAllBtn").onclick = () => {
    excluded = playlist.map(p => p.name);
    localStorage.setItem("excludedBGMs", JSON.stringify(excluded));
    location.reload();
  };

  $("includeAllBtn").onclick = () => {
    excluded = [];
    localStorage.setItem("excludedBGMs", JSON.stringify(excluded));
    location.reload();
  };

  $("volumeSlider").addEventListener("input", applyVolumeFromUI);
  $("muteBtn").addEventListener("click", toggleMute);

  loadYouTubeAPI();
});
</script>

</body>
</html>
