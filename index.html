<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Thocky's and Gillian's BGM Quiz</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<style>
  body{
    font-family: Arial, sans-serif;
    background:#101018;
    color:#f5f5f5;
    text-align:center;
    margin:0;
  }

  .hero{
    padding: 26px 14px 6px;
    max-width: 920px;
    margin: 0 auto;
  }
  .heroCard{
    background: #141420;
    border: 1px solid rgba(255,255,255,0.06);
    box-shadow: 0 0 18px rgba(0,0,0,0.45);
    border-radius: 14px;
    padding: 18px 18px 14px;
  }
  .title{
    margin: 2px 0 6px;
    font-size: 2.05rem;
    font-weight: 900;
    letter-spacing: 0.2px;
    line-height: 1.15;
  }
  .badgeRow{
    display:flex;
    justify-content:center;
    gap:10px;
    flex-wrap:wrap;
    margin-top: 8px;
  }
  .badge{
    display:inline-block;
    padding: 6px 12px;
    border-radius: 999px;
    font-size: 0.85rem;
    font-weight: 800;
    background: rgba(63,140,255,0.14);
    border: 1px solid rgba(63,140,255,0.28);
    color: #cfe2ff;
  }
  .desc{
    margin: 12px auto 0;
    max-width: 780px;
    line-height: 1.55;
    color: #d8d8e6;
    font-size: 0.98rem;
  }

  #controls, #answers, #excludeBox{
    background:#181824;
    margin:18px auto;
    padding:16px;
    max-width:560px;
    border-radius:10px;
    box-shadow:0 0 12px rgba(0,0,0,0.45);
  }

  button{
    background:#3f8cff;
    color:white;
    border:none;
    padding:7px 12px;
    border-radius:6px;
    cursor:pointer;
    font-weight:700;
    margin: 4px 6px;
  }

  input[type="text"]{
    width:240px;
    padding:7px 10px;
    background:#101018;
    border:1px solid #444;
    color:white;
    border-radius:6px;
  }

  .row{
    display:flex;
    justify-content:center;
    align-items:center;
    gap:10px;
    flex-wrap:wrap;
  }

  .microHint{
    margin-top: 8px;
    font-size: 0.88rem;
    color: #cfcfe6;
    opacity: 0.92;
  }
  .microHint b{ color:#ffffff; }

  .correct{ color:#5bd75b; }
  .wrong{ color:#ff6b6b; }

  /* IMPORTANT: iOS sometimes blocks audio if the iframe is fully hidden/off-screen.
     Keep it tiny + low opacity instead of off-screen. */
  #playerWrap{
    width: 1px;
    height: 1px;
    overflow: hidden;
    opacity: 0.01;
    margin: 0 auto;
  }

  #scoreLine{
    margin-top: 10px;
    display:flex;
    justify-content:center;
    gap:18px;
    font-size:1.05rem;
    font-weight:700;
  }

  #resultBox{
    margin-top:12px;
    padding:10px;
    border-radius:8px;
    background:#111120;
    min-height:60px;
  }

  #resultStatus{
    font-weight:900;
    font-size:1.15rem;
  }

  #resultTyped,
  #resultCorrect{
    font-size:0.95rem;
    margin-top:4px;
    color:#cfcfe6;
  }

  #excludeList, #answerList{
    columns:2;
    text-align:left;
    font-size:0.95rem;
    padding-left:18px;
  }

  @media (max-width:600px){
    #excludeList, #answerList{ columns:1; }
    input[type="text"]{ width: 90%; max-width: 280px; }
  }

  .hintBox{
    margin-top: 8px;
    padding: 10px;
    background: rgba(63,140,255,0.08);
    border-radius: 8px;
    font-size: 0.9rem;
  }

  .volRow{
    margin-top: 10px;
    display:flex;
    justify-content:center;
    align-items:center;
    gap:10px;
    flex-wrap:wrap;
  }
  input[type="range"]{
    width: 220px;
    accent-color: #3f8cff;
  }
  .pill{
    display:inline-block;
    padding: 6px 10px;
    border-radius: 999px;
    font-size: 0.85rem;
    font-weight: 800;
    background: rgba(255,255,255,0.06);
    border: 1px solid rgba(255,255,255,0.08);
    color: #e9e9ff;
  }
</style>
</head>

<body>

<div class="hero">
  <div class="heroCard">
    <div class="title">
      Thocky's and Gillian's<br>
      <span style="font-weight:800; font-size:1rem;">
        TOZ 24F BGM Quiz / Practice
      </span>
    </div>

    <div class="badgeRow">
      <span class="badge">DreamMS Version</span>
      <span class="badge">Practice Tool</span>
      <span class="badge">TOZ 24F</span>
    </div>

    <p class="desc">
      This quiz is built to help players train their TOZ 24F BGM recognition so they can identify maps by sound
      and contribute more confidently during TOZ runs.
    </p>
  </div>
</div>

<!-- Tiny (not off-screen) YouTube player container -->
<div id="playerWrap"><div id="player"></div></div>

<div id="controls">
  <div class="row">
    <button id="playBtn">Play!</button>
    <button id="stopBtn">Stop</button>
  </div>

  <!-- Volume controls -->
  <div class="volRow">
    <span class="pill">Volume</span>
    <input id="volSlider" type="range" min="0" max="100" step="1">
    <button id="muteBtn" type="button">Mute</button>
    <span id="volLabel" class="pill">100%</span>
  </div>

  <div style="height:10px"></div>

  <div class="row">
    <b>BGM:</b>
    <input type="text" id="guessInput" placeholder="Type map name here">
    <button id="submitBtn">Submit</button>
  </div>

  <div class="microHint">
    Note: Answers are <b>not case-sensitive</b>. Press <b>Enter</b> to submit.
  </div>

  <div id="resultBox">
    <div id="resultStatus"></div>
    <div id="resultTyped"></div>
    <div id="resultCorrect"></div>
  </div>

  <div id="scoreLine">
    <div>Correct: <span id="correctCount" class="correct">0</span></div>
    <div>Wrong: <span id="wrongCount" class="wrong">0</span></div>
  </div>

  <button id="resetBtn">Reset</button>
</div>

<div id="excludeBox">
  <h3>Exclude BGMs from Practice</h3>
  <p>
    Select BGMs you already mastered.<br>
    <b>Any checked BGM will be excluded</b> and will not appear in the quiz.
  </p>

  <button id="excludeAllBtn">Exclude All</button>
  <button id="includeAllBtn">Include All</button>

  <div class="hintBox">
    Tip: Exclude everything first, then untick only the BGMs you want to focus on.
  </div>

  <ul id="excludeList"></ul>
</div>

<div id="answers">
  <h3>Available BGMs</h3>
  <ul id="answerList"></ul>
</div>

<script src="https://www.youtube.com/iframe_api"></script>

<script>
const playlist = [
  { name: "Amoria", id: "hCdooZxzISo" },
  { name: "Aquarium", id: "qtw0sIBLjrw" },
  { name: "Ariant", id: "w1RgDSoOajw" },
  { name: "El Nath", id: "X6X7U5V9Obk" },
  { name: "Ellinia", id: "gfgBDs8z6WE" },
  { name: "Ereve", id: "3r9s43TG9yA" },
  { name: "Florina Beach", id: "9VqPnUL9Qvs" },
  { name: "Golden Temple", id: "Y_cihkgxF9A" },
  { name: "Henesys", id: "s2_MAplvHeQ" },
  { name: "Herb Town", id: "59oze7IkQ10" },
  { name: "Kerning City", id: "uv8QObpL2EY" },
  { name: "Korean Folk Town", id: "KK_IjvtszTA" },
  { name: "Leafre", id: "theIdIhZzVE" },
  { name: "Ludibrium", id: "49AZqVhXVeU" },
  { name: "Magatia", id: "5FDFLwPw0bU" },
  { name: "Mu Lung", id: "2VMCpGe9MGc" },
  { name: "Nautilus", id: "iZaVKkfuD6s" },
  { name: "New Leaf City", id: "EXv5madDarI" },
  { name: "Omega Sector", id: "LxQt8EVhBOs" },
  { name: "Orbis", id: "DThWMbPZXy8" },
  { name: "Perion", id: "9lwOsX763N0" },
  { name: "Rien", id: "YDfIfL_Fxec" },
  { name: "Shanghai", id: "uZ3egkrlMZY" },
  { name: "Sleepywood", id: "tWCWIhA3XQw" }
];

let player;
let playerReady = false;
let current = null;

let excluded = JSON.parse(localStorage.getItem("excludedBGMs") || "[]");

// volume state
let savedVol = Number(localStorage.getItem("bgmVol") || "100");
let savedMuted = localStorage.getItem("bgmMuted") === "1";

function getPool(){
  return playlist.filter(p => !excluded.includes(p.name));
}

function applyVolume(){
  if (!playerReady || !player) return;

  const vol = Math.max(0, Math.min(100, savedVol));
  if (savedMuted || vol === 0) {
    player.mute();
  } else {
    player.unMute();
  }
  player.setVolume(vol);
}

function safePlay(){
  // iOS can be flaky: try play, then retry shortly after
  try { player.playVideo(); } catch(e){}
  setTimeout(() => { try { player.playVideo(); } catch(e){} }, 200);
}

function onYouTubeIframeAPIReady(){
  player = new YT.Player("player", {
    height:"1",
    width:"1",
    videoId: playlist[0].id,
    playerVars: {
      playsinline: 1,
      controls: 0,
      rel: 0
    },
    events: {
      onReady: () => {
        playerReady = true;
        applyVolume();
      }
    }
  });
}

function playRandom(){
  if (!playerReady) {
    alert("Player is still loading, try again in a moment.");
    return;
  }

  const pool = getPool();
  if (!pool.length) return alert("All BGMs excluded!");

  current = pool[Math.floor(Math.random() * pool.length)];

  // Force unmute/volume AFTER a user gesture (this click)
  applyVolume();

  player.loadVideoById(current.id);
  safePlay();
}

function stopPlayback(){
  if (player && player.stopVideo) player.stopVideo();
  current = null;
}

function submitAnswer(){
  if (!current) return alert("Press Play first!");

  const input = document.getElementById("guessInput");
  const guessRaw = input.value.trim();
  if (!guessRaw) return alert("Please type your answer.");

  const guess = guessRaw.toLowerCase();
  const correct = current.name.toLowerCase();

  document.getElementById("resultTyped").textContent = "You submitted: " + guessRaw;
  document.getElementById("resultCorrect").textContent = "Correct answer: " + current.name;

  const statusEl = document.getElementById("resultStatus");
  const correctEl = document.getElementById("correctCount");
  const wrongEl = document.getElementById("wrongCount");

  if (guess === correct){
    statusEl.textContent = "Correct";
    statusEl.className = "correct";
    correctEl.textContent = Number(correctEl.textContent) + 1;
  } else {
    statusEl.textContent = "Wrong";
    statusEl.className = "wrong";
    wrongEl.textContent = Number(wrongEl.textContent) + 1;
  }

  input.value = "";
  input.focus();

  playRandom();
}

window.addEventListener("DOMContentLoaded", () => {
  const answerList = document.getElementById("answerList");
  const excludeList = document.getElementById("excludeList");

  // build lists
  playlist.forEach(p => {
    const li = document.createElement("li");
    li.textContent = p.name;
    answerList.appendChild(li);

    const ex = document.createElement("li");
    ex.innerHTML = `<label>
      <input type="checkbox" ${excluded.includes(p.name) ? "checked" : ""}>
      ${p.name}
    </label>`;

    ex.querySelector("input").onchange = e => {
      excluded = e.target.checked
        ? Array.from(new Set([...excluded, p.name]))
        : excluded.filter(x => x !== p.name);
      localStorage.setItem("excludedBGMs", JSON.stringify(excluded));
    };

    excludeList.appendChild(ex);
  });

  // buttons
  document.getElementById("playBtn").onclick = playRandom;
  document.getElementById("stopBtn").onclick = stopPlayback;
  document.getElementById("submitBtn").onclick = submitAnswer;

  document.getElementById("guessInput").addEventListener("keydown", e => {
    if (e.key === "Enter") {
      e.preventDefault();
      submitAnswer();
    }
  });

  document.getElementById("resetBtn").onclick = () => {
    document.getElementById("correctCount").textContent = "0";
    document.getElementById("wrongCount").textContent = "0";
    document.getElementById("resultStatus").textContent = "";
    document.getElementById("resultTyped").textContent = "";
    document.getElementById("resultCorrect").textContent = "";
  };

  document.getElementById("excludeAllBtn").onclick = () => {
    excluded = playlist.map(p => p.name);
    localStorage.setItem("excludedBGMs", JSON.stringify(excluded));
    location.reload();
  };

  document.getElementById("includeAllBtn").onclick = () => {
    excluded = [];
    localStorage.setItem("excludedBGMs", JSON.stringify(excluded));
    location.reload();
  };

  // volume UI
  const volSlider = document.getElementById("volSlider");
  const volLabel = document.getElementById("volLabel");
  const muteBtn = document.getElementById("muteBtn");

  volSlider.value = String(savedVol);
  volLabel.textContent = savedVol + "%";
  muteBtn.textContent = savedMuted ? "Unmute" : "Mute";

  function persistVol(){
    localStorage.setItem("bgmVol", String(savedVol));
    localStorage.setItem("bgmMuted", savedMuted ? "1" : "0");
    volLabel.textContent = savedVol + "%";
    muteBtn.textContent = savedMuted ? "Unmute" : "Mute";
    applyVolume();
  }

  volSlider.addEventListener("input", () => {
    savedVol = Number(volSlider.value);
    if (savedVol > 0) savedMuted = false;
    persistVol();
  });

  muteBtn.onclick = () => {
    savedMuted = !savedMuted;
    persistVol();
  };
});
</script>

</body>
</html>
